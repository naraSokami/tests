import subprocess
import os

check_leaks = True

tests = {
	"ft_get_flags": [
		(["./test", "ft_get_flags", ""], "(null) "),
		(["./test", "ft_get_flags", "%"], "(null) %"),
		(["./test", "ft_get_flags", "a"], "(null) a"),
		(["./test", "ft_get_flags", "testing"], "(null) testing"),
		(["./test", "ft_get_flags", "testing%"], "(null) testing%"),
		(["./test", "ft_get_flags", "test%#"], "(null) test%#"),
		(["./test", "ft_get_flags", "%#"], "(null) %#"),
		(["./test", "ft_get_flags", "%#-"], "(null) %#-"),
		(["./test", "ft_get_flags", "%#-0"], "(null) %#-0"),
		(["./test", "ft_get_flags", "#"], "# "),
		(["./test", "ft_get_flags", "-"], "- "),
		(["./test", "ft_get_flags", "0"], "0 "),
		(["./test", "ft_get_flags", "+"], "+ "),
		(["./test", "ft_get_flags", " "], "  "),
		(["./test", "ft_get_flags", "#-"], "#- "),
		(["./test", "ft_get_flags", "#-0"], "#-0 "),
		(["./test", "ft_get_flags", "#-+"], "#-+ "),
		(["./test", "ft_get_flags", "#- +0abc"], "#- +0 abc"),
		(["./test", "ft_get_flags", "#- +0testing"], "#- +0 testing"),
		(["./test", "ft_get_flags", "#- +0%"], "#- +0 %"),
		(["./test", "ft_get_flags", "#%"], "# %"),
		(["./test", "ft_get_flags", "#a"], "# a"),
		(["./test", "ft_get_flags", "#testing"], "# testing"),
		(["./test", "ft_get_flags", "#d"], "# d")
	],
	"ft_get_number": [
		(["./test", "ft_get_number", ""], "0 "),
		(["./test", "ft_get_number", "a"], "0 a"),
		(["./test", "ft_get_number", "%"], "0 %"),
		(["./test", "ft_get_number", "-0"], "0 -0"),
		(["./test", "ft_get_number", "+0"], "0 +0"),
		(["./test", "ft_get_number", "0"], "0 "),
		(["./test", "ft_get_number", "1"], "1 "),
		(["./test", "ft_get_number", "2"], "2 "),
		(["./test", "ft_get_number", "9"], "9 "),
		(["./test", "ft_get_number", "99"], "99 "),
		(["./test", "ft_get_number", "10"], "10 "),
		(["./test", "ft_get_number", "100"], "100 "),
		(["./test", "ft_get_number", "1000"], "1000 "),
		(["./test", "ft_get_number", "7test"], "7 test"),
		(["./test", "ft_get_number", "7%"], "7 %"),
		(["./test", "ft_get_number", "7 "], "7  "),
		(["./test", "ft_get_number", "7a"], "7 a")
	],
	"ft_printf": [
		# no %
		(["./test", ""], "[0]"),
		(["./test", "%"], "[0]"),
		(["./test", "%5%"], "%[1]"),
		(["./test", "%-5%"], "%[1]"),
		(["./test", "%-05%"], "%[1]"),
		(["./test", "a"], "a[1]"),
		(["./test", "simple test"], "simple test[11]"),
		# %%
		(["./test", "%%"], "%[1]"),
		(["./test", "%%a"], "%a[2]"),
		(["./test", "a%%"], "a%[2]"),
		(["./test", "a%%%%"], "a%%[3]"),
		(["./test", "a%%%%%%"], "a%%%[4]"),
		(["./test", "simple%% test"], "simple% test[12]"),
		(["./test", "%%simple test"], "%simple test[12]"),
		(["./test", "simple test%%"], "simple test%[12]"),
		# %d
		(["./test", "%d", "0"], "0[1]"),
		(["./test", "%d", "12"], "12[2]"),
		(["./test", "test %d", "0"], "test 0[6]"),
		(["./test", "test %d", "1"], "test 1[6]"),
		(["./test", "test %d", "9"], "test 9[6]"),
		(["./test", "test %d", "10"], "test 10[7]"),
		(["./test", "test %d", "100"], "test 100[8]"),
		(["./test", "test %d", "1000"], "test 1000[9]"),
		(["./test", "test %d", "-1"], "test -1[7]"),
		(["./test", "test %d", "-9"], "test -9[7]"),
		(["./test", "test %d", "-10"], "test -10[8]"),
		(["./test", "test %d", "-100"], "test -100[9]"),
		(["./test", "test %d", "-1000"], "test -1000[10]"),
		(["./test", "test %d", "2147483646"], "test 2147483646[15]"),
		(["./test", "test %d", "2147483647"], "test 2147483647[15]"),
		(["./test", "test %d", "-2147483647"], "test -2147483647[16]"),
		(["./test", "test %d", "-2147483648"], "test -2147483648[16]"),
		# %d + precision
		(["./test", "%.d", "7"], "7[1]"),
		(["./test", "%.0d", "7"], "7[1]"),
		(["./test", "%.1d", "7"], "7[1]"),
		(["./test", "%.2d", "7"], "07[2]"),
		(["./test", "%.3d", "7"], "007[3]"),
		(["./test", "%.d", "-7"], "-7[2]"),
		(["./test", "%.0d", "-7"], "-7[2]"),
		(["./test", "%.1d", "-7"], "-7[2]"),
		(["./test", "%.2d", "-7"], "-07[3]"),
		(["./test", "%.3d", "-7"], "-007[4]"),
		# %d + width
		(["./test", "%1d", "7"], "7[1]"),
		(["./test", "%01d", "7"], "7[1]"),
		(["./test", "%-1d", "7"], "7[1]"),
		(["./test", "%5d", "7"], "    7[5]"),
		(["./test", "%05d", "7"], "00007[5]"),
		(["./test", "%-5d", "7"], "7    [5]"),
		# %i
		(["./test", "%i", "0"], "0[1]"),
		(["./test", "%i", "12"], "12[2]"),
		(["./test", "test %i", "0"], "test 0[6]"),
		(["./test", "test %i", "1"], "test 1[6]"),
		(["./test", "test %i", "9"], "test 9[6]"),
		(["./test", "test %i", "10"], "test 10[7]"),
		(["./test", "test %i", "100"], "test 100[8]"),
		(["./test", "test %i", "1000"], "test 1000[9]"),
		(["./test", "test %i", "-1"], "test -1[7]"),
		(["./test", "test %i", "-9"], "test -9[7]"),
		(["./test", "test %i", "-10"], "test -10[8]"),
		(["./test", "test %i", "-100"], "test -100[9]"),
		(["./test", "test %i", "-1000"], "test -1000[10]"),
		(["./test", "test %i", "2147483646"], "test 2147483646[15]"),
		(["./test", "test %i", "2147483647"], "test 2147483647[15]"),
		(["./test", "test %i", "-2147483647"], "test -2147483647[16]"),
		(["./test", "test %i", "-2147483648"], "test -2147483648[16]"),
		# %u
		(["./test", "%d %u", "0", "-2147483648"], "0 0[3]"),
		(["./test", "%d %u", "0", "-2147483647"], "0 1[3]"),
		(["./test", "%d %u", "0", "-2147483639"], "0 9[3]"),
		(["./test", "%d %u", "0", "-2147483549"], "0 99[4]"),
		(["./test", "%d %u", "0", "-2147483638"], "0 10[4]"),
		(["./test", "%d %u", "0", "-2147483548"], "0 100[5]"),
		(["./test", "%d %u", "0", "-2147482648"], "0 1000[6]"),
		(["./test", "%d %u", "0", "2147483646"], "0 4294967294[12]"),
		(["./test", "%d %u", "0", "2147483647"], "0 4294967295[12]"),
		#x
		(["./test", "%d %x", "0", "-2147483648"], "0 0[3]"),
		(["./test", "%d %x", "0", "-2147483647"], "0 1[3]"),
		(["./test", "%d %x", "0", "-2147483639"], "0 9[3]"),
		(["./test", "%d %x", "0", "-2147483633"], "0 f[3]"),
		(["./test", "%d %x", "0", "-2147483632"], "0 10[4]"),
		(["./test", "%d %x", "0", "-2147483549"], "0 63[4]"),
		(["./test", "%d %x", "0", "-2147483638"], "0 a[3]"),
		(["./test", "%d %x", "0", "-2147483548"], "0 64[4]"),
		(["./test", "%d %x", "0", "-2147482648"], "0 3e8[5]"),
		(["./test", "%d %x", "0", "2147483646"], "0 fffffffe[10]"),
		(["./test", "%d %x", "0", "2147483647"], "0 ffffffff[10]"),
		# %x + #
		(["./test", "%d %#x", "0", "-2147483648"], "0 0[3]"),
		(["./test", "%d %#x", "0", "-2147483647"], "0 0x1[5]"),
		(["./test", "%d %#x", "0", "-2147483639"], "0 0x9[5]"),
		(["./test", "%d %#x", "0", "-2147483633"], "0 0xf[5]"),
		(["./test", "%d %#x", "0", "-2147483632"], "0 0x10[6]"),
		(["./test", "%d %#x", "0", "-2147483549"], "0 0x63[6]"),
		(["./test", "%d %#x", "0", "-2147483638"], "0 0xa[5]"),
		(["./test", "%d %#x", "0", "-2147483548"], "0 0x64[6]"),
		(["./test", "%d %#x", "0", "-2147482648"], "0 0x3e8[7]"),
		(["./test", "%d %#x", "0", "2147483646"], "0 0xfffffffe[12]"),
		(["./test", "%d %#x", "0", "2147483647"], "0 0xffffffff[12]"),
		#x + precision
		(["./test", "%d %#.0x", "0", "-2147483606"], "0 0x2a[6]"),
		(["./test", "%d %#.2x", "0", "-2147483606"], "0 0x2a[6]"),
		(["./test", "%d %#.3x", "0", "-2147483606"], "0 0x02a[7]"),
		(["./test", "%d %#.5x", "0", "-2147483606"], "0 0x0002a[9]"),
		# %X
		(["./test", "%d %X", "0", "-2147483648"], "0 0[3]"),
		(["./test", "%d %X", "0", "-2147483647"], "0 1[3]"),
		(["./test", "%d %X", "0", "-2147483639"], "0 9[3]"),
		(["./test", "%d %X", "0", "-2147483633"], "0 F[3]"),
		(["./test", "%d %X", "0", "-2147483632"], "0 10[4]"),
		(["./test", "%d %X", "0", "-2147483549"], "0 63[4]"),
		(["./test", "%d %X", "0", "-2147483638"], "0 A[3]"),
		(["./test", "%d %X", "0", "-2147483548"], "0 64[4]"),
		(["./test", "%d %X", "0", "-2147482648"], "0 3E8[5]"),
		(["./test", "%d %X", "0", "2147483646"], "0 FFFFFFFE[10]"),
		(["./test", "%d %X", "0", "2147483647"], "0 FFFFFFFF[10]"),
		# %X + #
		(["./test", "%d %#X", "0", "-2147483648"], "0 0[3]"),
		(["./test", "%d %#X", "0", "-2147483647"], "0 0X1[5]"),
		(["./test", "%d %#X", "0", "-2147483639"], "0 0X9[5]"),
		(["./test", "%d %#X", "0", "-2147483633"], "0 0XF[5]"),
		(["./test", "%d %#X", "0", "-2147483632"], "0 0X10[6]"),
		(["./test", "%d %#X", "0", "-2147483549"], "0 0X63[6]"),
		(["./test", "%d %#X", "0", "-2147483638"], "0 0XA[5]"),
		(["./test", "%d %#X", "0", "-2147483548"], "0 0X64[6]"),
		(["./test", "%d %#X", "0", "-2147482648"], "0 0X3E8[7]"),
		(["./test", "%d %#X", "0", "2147483646"], "0 0XFFFFFFFE[12]"),
		(["./test", "%d %#X", "0", "2147483647"], "0 0XFFFFFFFF[12]"),
		#X + precision
		(["./test", "%d %#.0X", "0", "-2147483606"], "0 0X2A[6]"),
		(["./test", "%d %#.2X", "0", "-2147483606"], "0 0X2A[6]"),
		(["./test", "%d %#.3X", "0", "-2147483606"], "0 0X02A[7]"),
		(["./test", "%d %#.5X", "0", "-2147483606"], "0 0X0002A[9]"),
		# %c
		(["./test", "%d %u %c", "0", "-2147483648", "0"], "0 0 0[5]"),
		(["./test", "%d %u %c", "0", "-2147483648", "a"], "0 0 a[5]"),
		(["./test", "%d %u %c", "0", "-2147483648", "b"], "0 0 b[5]"),
		(["./test", "%d %u %c", "0", "-2147483648", "!"], "0 0 ![5]"),
		# %s
		(["./test", "%d %u %c %s", "0", "-2147483648", "0", "NULL"], "0 0 0 (null)[12]"),
		(["./test", "%d %u %c %s", "0", "-2147483648", "0", ""], "0 0 0 [6]"),
		(["./test", "%d %u %c %s", "0", "-2147483648", "0", "0"], "0 0 0 0[7]"),
		(["./test", "%d %u %c %s", "0", "-2147483648", "0", "a"], "0 0 0 a[7]"),
		(["./test", "%d %u %c %s", "0", "-2147483648", "0", "test"], "0 0 0 test[10]"),
		(["./test", "%d %u %c %s", "0", "-2147483648", "0", "te st"], "0 0 0 te st[11]"),
		# %s + precision
		(["./test", "%d %u %c %.s", "0", "-2147483648", "0", "NULL"], "0 0 0 [6]"),
		(["./test", "%d %u %c %.03s", "0", "-2147483648", "0", "NULL"], "0 0 0 [6]"),
		(["./test", "%d %u %c %.-3s", "0", "-2147483648", "0", "NULL"], "0 0 0 [6]"),
		(["./test", "%d %u %c %.10s", "0", "-2147483648", "0", "NULL"], "0 0 0 (null)[12]"),
		(["./test", "%d %u %c %9.1s", "0", "-2147483648", "0", "NULL"], "0 0 0          [15]"),
		(["./test", "%d %u %c %.s", "0", "-2147483648", "0", ""], "0 0 0 [6]"),
		(["./test", "%d %u %c %.0s", "0", "-2147483648", "0", ""], "0 0 0 [6]"),
		(["./test", "%d %u %c %.1s", "0", "-2147483648", "0", ""], "0 0 0 [6]"),
		(["./test", "%d %u %c %.5s", "0", "-2147483648", "0", ""], "0 0 0 [6]"),
		(["./test", "%d %u %c %.s", "0", "-2147483648", "0", "a"], "0 0 0 [6]"),
		(["./test", "%d %u %c %.0s", "0", "-2147483648", "0", "a"], "0 0 0 [6]"),
		(["./test", "%d %u %c %.1s", "0", "-2147483648", "0", "a"], "0 0 0 a[7]"),
		(["./test", "%d %u %c %.5s", "0", "-2147483648", "0", "a"], "0 0 0 a[7]"),
		(["./test", "%d %u %c %.s", "0", "-2147483648", "0", "testing"], "0 0 0 [6]"),
		(["./test", "%d %u %c %.0s", "0", "-2147483648", "0", "testing"], "0 0 0 [6]"),
		(["./test", "%d %u %c %.1s", "0", "-2147483648", "0", "testing"], "0 0 0 t[7]"),
		(["./test", "%d %u %c %.5s", "0", "-2147483648", "0", "testing"], "0 0 0 testi[11]"),
		(["./test", "%d %u %c %.7s", "0", "-2147483648", "0", "testing"], "0 0 0 testing[13]"),
		(["./test", "%d %u %c %.20s", "0", "-2147483648", "0", "testing"], "0 0 0 testing[13]"),
		# precision
		(["./test", "%.5d %.5u %.5c %.5s", "0", "-2147483648", "0", ""], "00000 00000 0 [14]"),
		(["./test", "%0.5d %0.5u %0.5c %0.5s", "0", "-2147483648", "0", ""], "00000 00000 0 [14]"),
		(["./test", "%0-.5d %0-.5u %0-.5c %0-.5s", "0", "-2147483648", "0", ""], "00000 00000 0 [14]"),
		(["./test", "%-0.5d %-0.5u %-0.5c %-0.5s", "0", "-2147483648", "0", ""], "00000 00000 0 [14]"),
		# width
		(["./test", "%5d %5u %5c %5s", "0", "-2147483648", "0", ""], "    0     0     0      [23]"),
		(["./test", "%05d %05u %05c %05s", "0", "-2147483648", "0", ""], "00000 00000     0      [23]"),
		(["./test", "%0-5d %0-5u %0-5c %0-5s", "0", "-2147483648", "0", ""], "0     0     0          [23]"),
		(["./test", "%-05d %-05u %-05c %-05s", "0", "-2147483648", "0", ""], "0     0     0          [23]"),
	]
}

for name, test in tests.items():
	print(f"{name}: ", end='')
	is_ok = True
	bad_count = 0

	for i, (cmd, expected_output) in enumerate(test, 1):
		try:
			result = subprocess.run(cmd, capture_output=True, text=True, check=True)
			actual_output = result.stdout

			if actual_output != expected_output and bad_count < 5:
				if is_ok:
					print("\033[91mfailed\033[0m")
					is_ok = False
				print(f"  [Test {i}] \033[91mdoes not match\033[0m")
				print(f"    \033[93mCommand: {' '.join(cmd)}")
				print(f"    Expected: \"{expected_output}\"")
				print(f"    Got:      \"{actual_output}\"\033[0m")
				bad_count += 1

		except subprocess.CalledProcessError as e:
			print(f"  [Test {i}] \033[91mcrash: {' '.join(cmd)}\033[0m")
			print(f"    Exit code: {e.returncode}")
			print(f"    Stderr: {e.stderr.strip() if e.stderr else 'None'}")
	
		if check_leaks:
			leaks_cmd = ["./tests/leaks.sh"] + cmd
			leaks_result = subprocess.run(leaks_cmd, capture_output=True, text=True)
			leaks_stdout = leaks_result.stdout
	
			if leaks_stdout.strip() != "" and bad_count < 5:
				if is_ok:
					print("\033[91mfailed\033[0m")
					is_ok = False
				print(f"  [Test {i}] \033[91m[LEAKS]\033[0m")
				print(f"    \033[93mCommand: {' '.join(leaks_cmd)}")
				print(f"    Lost: {leaks_stdout}\033[0m")
				bad_count += 1

	if is_ok:
		print(f"\033[92mpassed\033[0m")
